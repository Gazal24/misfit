- if @md

  Payments collected by 
  = select :name => "payment[received_by]", :collection => staff_members_collection, :selected => @center.manager.id.to_s

  %table.report.nojs
    %thead
      %tr{:style => "font-size: 0.85em;"}
        %th name
        %th id
        %th amount
        %th outstanding
        %th disbursed on
        %th installment
        %th principal due
        %th interest due
        %th total due
        %th paid
        %th repayment type
          
    %tbody{:style => "text-align:left;" }
      - tot_amount, tot_outstanding, tot_installments, tot_principal, tot_interest, tot_fees, tot_total = 0, 0, 0, 0, 0, 0, 0
      - @center.clients.each do |client|
        - loan_row_count = 0
        - Loan.all(:client_id => client.id, :disbursal_date.not => nil).each do |loan|
          - lh = loan.history(:date => @date)[0] #TODO make this work even for non payment dates
          - #next if [nil, :repaid, :pending].include? loan.status
          - loan_row_count += 1
          %tr{ :class => cycle('odd','') }
            %td.text
              %b= link_to loan.client.name, resource(@center.branch, @center, loan.client)
            %td.number
              = loan.id
            %td.number
              - amt = loan.amount
              %b= amt.to_currency
              - tot_amount += amt
            %td.number
              - p = lh.nil? ? 0 : lh.actual_outstanding_principal
              %b= p.to_currency
              - tot_outstanding += p
            %td.text
              = loan.disbursal_date.to_s
            %td.number
              - ins = loan.number_of_installments_before(@date)
              = ins
              - tot_installments += ins
            %td.number
              - p = lh.nil? ? 0 : lh.principal_due.to_i
              = p.to_currency
              - tot_principal += p
            %td.number
              - i = lh.nil? ? 0 : lh.interest_due.to_i
              = i.to_currency
              - tot_interest += i
            %td.number
              - a = p + i
              = a.to_currency
              - tot_total += a
            %td.number
              - if a == 0
                = lh.nil? ? 0 : (lh.principal_paid.to_i + lh.interest_paid.to_i)
              - else 
                = text_field :name => "paid[loan][#{loan.id}", :value => (a > 0 ? a : 0), :cols => "5", :style => "width:50px;" 
            %td 
              = select :name => "payment_style[#{loan.id}]", :collection => [["prorata","pro rata"],["normal","fees => int => prin."]]

        - if loan_row_count == 0
          %tr{ :class => cycle('odd','') }
            %td.text
              %b= link_to client.name, resource(@branch, @center, client)
            %td{ :colspan => 10 }
              %i nothing outstanding
      %tr{ :style => 'border-bottom: 2px solid;' }
        %tr
          %td
          %td
          %td
          %td.numeric
            %b= tot_amount.to_currency
          %td.numeric
            %b= tot_outstanding.to_currency
          %td
          %td
          %td.numeric
            %b= tot_principal.to_currency
          %td.numeric
            %b= tot_interest.to_currency
          %td
            %b= tot_total.to_currency
          %td
          %td.numeric            
    %tfoot    
      %tr
        %td{ :colspan => 14 }

    

- else
  %i This day is not a meeting day
