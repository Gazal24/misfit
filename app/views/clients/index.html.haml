/- if @center.clients.loans.size > 0
/  .graph
/    = ofc2(430, 200, 'http://' + request.env['HTTP_HOST'] + url(:graph_data, :action => 'center', :id => @center.id, :scope_unit => 'months', :scope_size => 3) )


%h1== Center: <i>#{@center.name}</i>

%table.narrow.form{ :style => "width: 40%;" }
  %tr.odd
    %td name
    %td
      %b= @center.name
      == (id: #{@center.id})
  %tr
    %td manager
    %td= link_to @center.manager.name, resource(@center.manager)
  %tr.odd
    %td in branch
    %td
      = link_to @branch.name, resource(@center.branch)
      %br/
      %span.greytext
        managed by:
        = link_to @center.branch.manager.name, resource(@center.manager)
  %tr
    %td meeting
    %td== #{@center.meeting_day.to_s.capitalize}#{(@center.meeting_time_hours and @center.meeting_time_minutes) ? ", #{@center.meeting_time_hours}:#{@center.meeting_time_minutes}" : ''}


%p= link_to 'edit this center\'s details', resource(@branch, @center, :edit)

%h2== Clients of the <i>#{@center.name}</i> center

%p
  == Manage existing clients or #{link_to 'add a new client', resource(@branch, @center, :clients, :new)}.

- if @clients.blank?
  %p
    %i== No clients for the #{@branch.name} branch yet.
- else
  %table.narrow.form{ :width => '100%' }
    %thead
      %tr
        %th
        %th id
        %th name
        %th loans
    %tbody
    - @clients.each do |client|
      %tr{ :class => cycle('odd','') }
        %td &nbsp;
        %td
          = client.id
        %td
          %b= link_to client.name, resource(@branch, @center, client)
        %td
          %b= client.loans.size
          == (#{link_to 'view', resource(@branch, @center, client, :loans)})
        %td
          = link_to 'edit', resource(@branch, @center, client, :edit)
          &nbsp;|&nbsp;
          = link_to 'new loan', resource(@branch, @center, client, :loans, :new)

    %tfoot
      %tr
        %td{ :colspan => 7 }


  = link_to 'Create new client', resource(@branch, @center, :clients, :new)

  %p
    %br/
  %h2
    == Week #{@date.cweek} meeting sheet for center #{@center.name}
    %a{ :name => 'weeksheet' }/

  %table.narrow.form{ :style => "width: 100%;" }
    %tr.odd
      %td meeting at
      %td
        - if @center.meeting_day?(@date)
          %b== #{@date} #{@center.meeting_time}
        - else
          %i no meeting today
      %td
        = link_to 'today', resource(@branch, @center, :date => Date.today) + '#weeksheet'
        &nbsp;|&nbsp;
        = link_to 'previous meeting', resource(@branch, @center, :date => @center.previous_meeting_date_from(@date)) + '#weeksheet'
        &nbsp;|&nbsp;
        = link_to 'next meeting', resource(@branch, @center, :date => @center.next_meeting_date_from(@date)) + '#weeksheet'
    %tr
      %td center manager
      %td= link_to @center.manager.name, resource(@center.manager)
      %td
        %form{ :action => resource(@branch, @center), :method => 'GET', :style => 'margin: 0px; padding: 0px;'  }
          = date_select 'date', @date
          = submit 'Go!',  :style => 'margin: 0px; padding: 0px;'


- if @center.meeting_day? @date
  %table.narrow.form{ :width => '100%' }
    %thead
      %tr
        %th
        %th on name
        %th id
        %th amount
        %th outstanding
        %th.center status
        %th disbursed on
        %th funder
        %th installment
        %th principal due
        %th interest due
        %th total due
    %tbody
      - tot_amount, tot_outstanding, tot_installments, tot_principal, tot_interest, tot_total = 0, 0, 0, 0, 0, 0
      - @clients.each do |client|
        - loan_row_count = 0
        - Loan.all(:client_id => client.id).each do |loan|
          - #next if [nil, :repaid, :pending].include? loan.status
          - loan_row_count += 1
          %tr{ :class => cycle('odd','') }
            %td &nbsp;
            %td
              %b= link_to loan.client.name, resource(@branch, @center, loan.client)
            %td
              = loan.id
            %td.numeric
              - i = loan.amount
              %b= i.to_currency
              - tot_amount += i
            %td.numeric
              - i = loan.actual_outstanding_principal_on(@date)
              %b= i.to_currency
              - tot_outstanding += i
            %td.center
              = loan.get_status(@date).to_s
            %td
              = loan.disbursal_date.to_s
            %td
              = loan.funder_name
            %td.numeric
              - i = loan.number_of_installments_before(@date)
              = i
              - tot_installments += i
            %td.numeric
              - i = [-loan.principal_overpaid_on(@date), 0].max
              = i.to_currency
              - tot_principal += i
            %td.numeric
              - i = [-loan.interest_overpaid_on(@date), 0].max
              = i.to_currency
              - tot_interest += i
            %td.numeric
              - i = [-loan.total_overpaid_on(@date), 0].max
              = i.to_currency
              - tot_total += i
        - if loan_row_count == 0
          %tr{ :class => cycle('odd','') }
            %td
            %td
              %b= link_to client.name, resource(@branch, @center, client)
            %td{ :colspan => 5 }
              %i nothing outstanding
      %tr{ :style => 'border-bottom: 2px solid;' }
        %tr
          %td
          %td
          %td
          %td.numeric
            %b= tot_amount.to_currency
          %td.numeric
            %b= tot_outstanding.to_currency
          %td
          %td
          %td
          %td.numeric
            %b= tot_installments
          %td.numeric
            %b= tot_principal.to_currency
          %td.numeric
            %b= tot_interest.to_currency
          %td.numeric
            %b= tot_total.to_currency
            
    %tfoot    
      %tr
        %td{ :colspan => 12 }

- else
  %i This day is not a meeting day