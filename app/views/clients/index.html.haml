.graph
  = ofc2(430, 200, 'http://' + request.env['HTTP_HOST'] + url(:graph_data, :action => 'center', :id => @center.id, :scope_unit => 'months', :scope_size => 3) )


%h1== Center: <i>#{@center.name}</i>

%table.narrow.form{ :style => "width: 40%;" }
  %tr.odd
    %td name
    %td
      %b= @center.name
      == (code: #{@center.code}, id: #{@center.id})
  %tr
    %td manager
    %td= link_to @center.manager.name, resource(@center.manager)
  %tr.odd
    %td in branch
    %td
      = link_to @branch.name, resource(@center.branch)
      %br/
      %span.greytext
        managed by:
        = link_to @center.branch.manager.name, resource(@center.manager)
  %tr
    %td meeting
    %td== #{@center.meeting_day.to_s.capitalize}#{(@center.meeting_time_hours and @center.meeting_time_minutes) ? ", #{@center.meeting_time_hours}:#{@center.meeting_time_minutes}" : ''}


%p
  = link_to 'edit this center\'s details', resource(@branch, @center, :edit), :class => "edit"
  = link_to 'add a new client', resource(@branch, @center, :clients, :new), :class => "add"

%h2== Clients of the #{@center.name} center


- if @clients.blank?
  %p
    %i== No clients for the #{@branch.name} branch yet.
- else
  %table.narrow.form{ :width => '100%' }
    %thead
      %tr
        %th
        %th id
        %th name
        %th loans
        %th
    %tbody
    - group=-1
    - @clients.each do |client|
      - if group!=client.client_group_id
        - group = client.client_group_id 
        %tr
          %td{:colspan => 5, :align => "center", :style => "background: #eee"}
            - if client.client_group
              %b
                = client.client_group.name
                (
                =link_to('edit', resource(@branch, @center, client.client_group, :edit))
                )
            -else
              "Not attached to any center"
            
      %tr{ :class => cycle('odd','') }
        %td &nbsp;
        %td
          = client.id
        %td
          %b= link_to client.name, resource(@branch, @center, client)
        %td
          %b= client.loans.size
          == (#{link_to 'view', resource(@branch, @center, client, :loans)})
        %td
          = link_to 'edit', resource(@branch, @center, client, :edit)
          &nbsp;|&nbsp;
          = link_to 'new loan', resource(@branch, @center, client, :loans, :new)

    %tfoot
      %tr
        %td{ :colspan => 7 }


  = link_to 'Create new client', resource(@branch, @center, :clients, :new)

  %p
    %br/
  %h1
    == <a name = 'weeksheet'>Week #{@date.cweek} meeting sheet for center #{@center.name}</a>
  = link_to 'Record these activities', url(:enter_payments, :action => 'by_center', :center_id => @center.id, :for_date => @date), :class => "add"

  %table.narrow.form{ :style => "width: 100%;" }
    %tr.odd
      %td meeting at
      %td
        - if @center.meeting_day?(@date)
          %b== #{@date} #{@center.meeting_time}
        - else
          %i no meeting today
      %td
        = link_to 'today', resource(@branch, @center, :date => Date.today) + '#weeksheet'
        &nbsp;|&nbsp;
        = link_to 'previous meeting', resource(@branch, @center, :date => @center.previous_meeting_date_from(@date)) + '#weeksheet'
        &nbsp;|&nbsp;
        = link_to 'next meeting', resource(@branch, @center, :date => @center.next_meeting_date_from(@date)) + '#weeksheet'
    %tr
      %td center manager
      %td= link_to @center.manager.name, resource(@center.manager)
      %td
        %form{ :action => resource(@branch, @center), :method => 'GET', :style => 'margin: 0px; padding: 0px;'  }
          = date_select 'date', @date
          = submit 'Go!',  :style => 'margin: 0px; padding: 0px;'


%a{:name => "weeksheet"}
%h2 Approvals
- @loans_to_approve = @center.clients.loans(:approved_on => nil)
- if @loans_to_approve.size > 0
  %table.narrow.form{ :width => '100%'}
    %thead
      %tr{:style => "font-size: 0.85em;"}
        %th
          Name
        %th
          Scheduled Disbursal Date
        %th
          Status
    - @loans_to_approve.each do |loan|
      %tr
        %td
          = loan.client.name
        %td
          = loan.scheduled_disbursal_date
        %td
          - late =  @date - loan.scheduled_disbursal_date
          - if late > 0
            == "#{late} days late"
          - else
            on time
- else
  No approvals today

- if @center.meeting_day? @date

  %h2 Disbursals
  - loans_to_disburse = @center.clients.loans(:scheduled_disbursal_date.lte => @date, :disbursal_date => nil, :approved_on.not => nil)
  - if loans_to_disburse.size > 0
    %table.narrow.form{ :width => '100%'}
      %thead
        %tr{:style => "font-size: 0.85em;"}
          %th
            Name
          %th
            Scheduled Disbursal Date
          %th
            Status
      - loans_to_disburse.each do |loan|
        %tr
          %td
            = loan.client.name
          %td
            = loan.scheduled_disbursal_date
          %td
            - late =  @date - loan.scheduled_disbursal_date
            - if late > 0
              == "#{late} days late"
            - else
              on time
  - else
    No disbursals today
  %h2 Payments
  %table.narrow.form{:width => '100%', :cellpadding => 2}
    %thead
      %tr
        %th on name
        %th loan id
        %th amount
        %th outstanding
        %th disbursed on
        %th installment
        %th principal due
        %th interest due
        %th total due
    %tbody
      - tot_amount, tot_outstanding, tot_installments, tot_principal, tot_interest, tot_total = 0, 0, 0, 0, 0, 0
      - @clients.each do |client|
        - loan_row_count = 0
        - Loan.all(:client_id => client.id).each do |loan|
          - #next if [nil, :repaid, :pending].include? loan.status
          - loan_row_count += 1
          %tr{ :class => cycle('odd','') }
            %td
              %b= link_to loan.client.name, resource(@branch, @center, loan.client)
            %td
              = link_to loan.id, url(:quick_link, "loans", loan.id)
            %td.numeric
              - i = loan.amount
              %b= i.to_currency
              - tot_amount += i
            %td.numeric
              - i = loan.actual_outstanding_principal_on(@date)
              %b= i.to_currency
              - tot_outstanding += i
            %td
              = loan.disbursal_date.to_s
            %td.numeric
              - i = loan.number_of_installments_before(@date)
              = i
              - tot_installments += i
            %td.numeric
              - i = [-loan.principal_overpaid_on(@date), 0].max
              = i.to_currency
              - tot_principal += i
            %td.numeric
              - i = [-loan.interest_overpaid_on(@date), 0].max
              = i.to_currency
              - tot_interest += i
            %td.numeric
              - i = [-loan.total_overpaid_on(@date), 0].max
              = i.to_currency
              - tot_total += i
        - if loan_row_count == 0
          %tr{ :class => cycle('odd','') }
            %td
              %b= link_to client.name, resource(@branch, @center, client)
            %td{ :colspan => 4 }
              %i nothing outstanding
      %tr{ :style => 'border-bottom: 2px solid;' }
        %tr
          %td
          %td
          %td.numeric
            %b= tot_amount.to_currency
          %td.numeric
            %b= tot_outstanding.to_currency
          %td
          %td
          %td.numeric
            %b= tot_principal.to_currency
          %td.numeric
            %b= tot_interest.to_currency
          %td.numeric
            %b= tot_total.to_currency
            
    %tfoot    
      %tr
        %td{ :colspan => 11 }  
- else
  %i This day is not a meeting day
