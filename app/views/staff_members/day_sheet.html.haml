%h1 
  Day sheet for 
  = @staff_member.name
  for 
  = @date 

= link_to "Download pdf", url(:day_sheet_with_format, :format => "pdf", :date => @date), :style => "float: right;"
- @centers.each do |center|
  %h2
    = center.id
    = center.name
  %table.narrow.form{ :width => '100%' }
    %thead
      %tr
        %th{:colspan => 12}
          Collections
      %tr
        %th
        %th on name
        %th id
        %th amount
        %th outstanding
        %th.center status
        %th disbursed on
        %th funder
        %th installment
        %th principal due
        %th interest due
        %th total due
    %tbody
      - tot_amount, tot_outstanding, tot_installments, tot_principal, tot_interest, tot_total = 0, 0, 0, 0, 0, 0
      - center.clients.each do |client|
        - loan_row_count = 0
        - client.loans.each do |loan|
          - next if [nil, :repaid, :pending].include? loan.get_status
          - loan_row_count += 1
          %tr{ :class => cycle('odd','') }
            %td &nbsp;
            %td
              %b= loan.client.name
            %td
              = loan.id
            %td.numeric
              - i = loan.amount
              %b= i.to_currency
              - tot_amount += i
            %td.numeric
              - i = loan.actual_outstanding_principal_on(@date)
              %b= i.to_currency
              - tot_outstanding += i
            %td.center
              = loan.get_status(@date).to_s
            %td
              = loan.disbursal_date.to_s
            %td
              = loan.funder_name
            %td.numeric
              - i = loan.number_of_installments_before(@date)
              = i
              - tot_installments += i
            %td.numeric
              - i = [-loan.principal_overpaid_on(@date), 0].max
              = i.to_currency
              - tot_principal += i
            %td.numeric
              - i = [-loan.interest_overpaid_on(@date), 0].max
              = i.to_currency
              - tot_interest += i
            %td.numeric
              - i = [-loan.total_overpaid_on(@date), 0].max
              = i.to_currency
              - tot_total += i
        - if loan_row_count == 0
          %tr{ :class => cycle('odd','') }
            %td
            %td
              %b=  client.name
            %td{ :colspan => 10 }
              %i nothing outstanding
      %tr
        %tr{ :style => 'border-bottom: 2px solid;font-weight: bold;border-top: solid 1px #aaa;' }
          %td
          %td
          %td
          %td.numeric
            %b= tot_amount.to_currency
          %td.numeric
            %b= tot_outstanding.to_currency
          %td
          %td
          %td
          %td.numeric
            %b= tot_installments
          %td.numeric
            %b= tot_principal.to_currency
          %td.numeric
            %b= tot_interest.to_currency
          %td.numeric
            %b= tot_total.to_currency
    %tfoot    
      %tr
        %td{ :colspan => 12 }
  - if center.clients.loans.all(:scheduled_disbursal_date => @date).count > 0
    - tot_disbursement = 0
    %table.narrow.form{ :width => '100%' }
      %tr
        %thead
          %th{:colspan => "12"}
            Disbursements
      - center.clients.loans.all(:scheduled_disbursal_date => @date).each do |loan|
        - tot_disbursement += loan.amount
        %tr
          %td 
            = loan.client.name
          %td 
            = loan.amount
      %tr{ :style => 'border-bottom: 2px solid;font-weight: bold;border-top: solid 1px #aaa;' }
        %td
          Total Disbursement
        %td
          = tot_disbursement
      %tfoot    
        %tr
          %td{ :colspan => 12 }
  - else
    No disbursements today
            
            
            

